### os operations and enterprise operations:
توی os اوپریشنش به دو بخش تقسیم میشه: یوزرلند و کرنل لند کرنل جاییه که ما بهش دسترسی نداریم و با استفاده از dll واسطه میتونیم به object های داخل کرنل دسترسی داشته باشیم حالا هر اتفاقی که داخل کرنل میفته میتونه یه پروایدر داشته باشه و بسته به ارتباط ما با پروایدر ها میتونیم این پروایدرها رو بیاریم تو یوزر لند تا ازشون لاگ تولید کنیم ولی همه پروایدر ها تو یوزرلند لاگ ندارند فقط اونایی دارند که property شون event log باشه لاگ تولید میکنند(log file name براشون ست شده باشه و دایرکتوری براشون ست شده باشه که بتونه برامون لاگ تولید کنه اگه ما برا پروایدر event trace session تعریف کنیم میتونه لاگ تولید کنه (معنیش این نیست که لاگ تولید میکنه صرفا تواناییش رو پیدا میکنه))
تو هر سازمان از لحاظ operation برای نگاه به حمله به دو دسته کلاینت ساید هست و سرور ساید تقسیم میشوند
تو بخش کلاینت های operational میشه ادمین تا حراست سیستم جلوی در میشن که به شبکه داخلی مثل active directory وصل میشن
### دلیل اهمیت windows log:
تو بخش سرور ساید از پلتفرم های اصلی استفاده میشن: ویندوز و لینوکس(خیلیا رو سرور ساید معمولا لینوکسن به خاطر بیزینس سازمان و رویکرد) تو کلاینت همیشه ویندوز هم هست و کلا تو سرور ساید معمولا برای سرویس هایی مثل active directory که جایگزین نداره باید از ویندوز استفاده کنند تو سرور ساید برای iis هم تو وب اپلیکیشن باید از ویندوز استفاده بشه و چیزای دیگه مثل sql server , برای مدیریت و پچ کردن روی پلتفرم ها(مخصوصا پلتفرم های ویندوزی) و آپدیت از sccm استفاده میشه , azure(زیر مجموعه اکتیو دایرکتوری روی cloud تو ایران معمولا سمتش نمیریم و رویکرد معمولا کلا داخل سازمانه) و exchange
معمولا هکر ها تمرکز خودشون رو رو ویندوز میزارن برای حمله چون فراگیر تره و باگ های زیادی برای اون میزارن برای همین باید تمرکز رو بزاریم روی تحلیل لاگ های ویندوزی
ویندوز در حالت default با تنظیمات default میتونه حدود کمی رو تشخیص بده برای معیار داشتن میایم فریمورک تشخیص حملات رو انتخاب میکنیم تا با اون متر و معیار بزاریم برای سطح تشخیصمون مثلا فریمورک sigma= sigma rule github
### فریمورک sigma:
یک فریمورک rule عه
این فریمورک میتونه با signature هایی که داره به تشخیص کمک کنه و با rule های داخلش سطح تشخیص رو بالا ببره کلی از rule های سیگما با توجه به سیسمان است 

راه های نفوذ به کلاینت ساید:
ایمیل مخرب
fishing
social (کلیک روی لینک یا دانلود فایل)
exploit vulnerability

حالا شروع میکنه به پخش کردن دسترسیش و بالا بردن دسترسیش(privilage escalation) با password dumping که این منجر به کاشتن rat هکر میشه و دسترسیش حفظ میشه و دسترسیش بالا هم میره و تو قدم بعدی pivot میکنه(پخش میکنه دسترسیش رو) و به نقاطی که دسترسی داره
شناختن بیزنس و تهدیدات اون مهمه چون روی طریق حمله تاثیر داره تا بشه حملات رو پیش بینی کرد مثلا برای شرکت دارویی که روی یکی از سرواش تکنولوژی مهم داره برای رسیدن به اطلاعات مهم هکر از lateral movement ممکنه استفاده کنن تا دسترسی شون پخش بشه مثلا میدونن که احتمالا ادمین رو جاهای مختلف لاگین کنن پس میان پسورد رو میدزدن تا پخش کنن دسترسی شون رو
لاگ منیجمنت و siem: یک نقطه مرکزی برای جمع آوری لاگ ها از سازمان (از نقطه به نقطه شبکه لاگ و جمع میکنه برای تحلیل و بررسی شواهد شبکه)
sigma:
مجموعه ای از rule ها برای پلتفرم های مختلف یک سری signature برای تشخیص حمله مثلا registry یه نقطه مهم برای persistence عه چون کامپیوتر میاد فایل هارو میخونه و بر همون اساس رفتار میکنه سیگما میاد با زبون مختص خودش فرمتش بر اساس yml بر اساس یه لاگ مثلا svchost میاد بررسی میکنه 
این بخش مهمشه
شناختن ردپا: وقتی که siem یا لاگ منیجمنت برای خودم دارم مثل اسپلانک یا elk (siem نیست) یا qradar یا ... میای یه خط rule مینویسی براش میاد لاگ هایی که جمع میشن و بعد با اون rule مچ بشن میاد alert تولید میکنه برای ما

پس میایم لاگ هارو جمع میکنیم میریزیم تو یه نقطه بعد با signature مقایسه ش میکنیم بعد اگه مچ شدن alert تولید میشه که منجر به شناسایی حمله میشه
حالا ما اگر مثلا از اسپلانک استفاده میکنیم باید rule های سیگما رو ترجمه کنیم تو اسپلانک(splunk base)
مثلا برای حمله password dumping توی پروسه lsass.exe هکر میاد با ابزاری مثل mimi cat میاد روی lsass.exe دسترسی میگیره به خونه ای از حافظه و رم که پسورد ها توش سیو میشن دسترسی میگیره این رفتار توسط سیسمان لاگ میشه این سیسمان یه event id داره که اسمش event id 10 عه که میگه پروسس mimi cat اومده روی پروسه lsass.exe دسترسی گرفته حالا سیگما یه rule داره 
میاد کتگوری رو مشخص میکنه و event id رو که 10 عه که اگر تارگت lsass.exe  بود میاد اون rule فایر میشه و سیگما تشخصی میده چیرو دامپ کنه ورودیش هم باید از سیسمان باشه
اگر پلتفرم ها متفاوت باشه سیگما میاد ابزار api base رو معرفی میکنه به اسم uncoder
### برای translate کردن رول سیگما:
میام تو سایت uncoder رول سیگما رو به طور کامل واردش میکنم و میگم که به من چی بده مثلا برای استیک کوری(steak query)
مثلا میتونم پاور شل بزنم و با اجرا کردن اسکریپت پاور شل بگردم تو ایونت ها
### جمع بندی:
پس تو حالت کلی ویندوز لاگ ها وارد میشن تو لاگ منیجمنت من(siem من) بعد اون siem من چند تا فیلتر داره اول جایی که لاگ ها store میشن بعد میدم به سیگما رول ها خروجی میده اگر یکی از لاگ های ویندوز با سیگما رول مچ بشن خروجی alert میده حالا لزوما اون alert ها خروجیش true positive نیست  و false positive ش زیاده و  ما برای detection دقیق دنبال true positive  هستیم که اینجا فرایند tune شروع میشه که بزاریم سیگما داخل شبکه کار کنه و بعد از tune ما به ریت خوبی از alert های true positive  میرسیم.
## ETW(event tracing for windows):
میاد تاثیراتی که از کرنل سرویس ها و اپلیکیشن ها و هر چیزی که داخل ویندوزه با زیر ساخت زیر باز میکنه و باعث میشه هر چی که داخل کرنله یه نوع لاگ تولید بشه که قابل استفاده بش
 سه بخش داره:
controller :
میاد ایونت تریس رو باز میکنه یک سشن میسازه و یک فعالیت رو تریس کرده و تبدیل به لاگ میکنه
provider:
پروایدر کرنلی توی ویندوز بسته به اتفاقات و نیاز میاد لاگ تولید میکنه(سیسمان به این عنوان میتونه استفاده بشه )
consumer:
مصرف کننده لاگ ها
بخشی برمیگرده به استفاده انسان ها از لاگ تولیدی و بخشی مربوط به منابع داخلی که خود ویندوز مصرف میکنه
همه ی این سه تا قبل از تولید event viewer هستش 
#### ابزار لاگ من(logman):
یه ابزار کنترلره که میتونه سشن بسازه با پروایدر ها کار کنه و سشن های مختلف رو تریس کنه رو خود ویندوز هست
با این میتونم لیست ایونت سشن تریس هارو ببینم
میای cmd رو ران ادمین میکنی بعد میزنی:
logman query -ets
این -ets میاد اطلاعات اون بخش رو میده بهم
هر کدوم از ایونت سشن تریس ها برای پروگرم خاص
یه نقطه ای برای consume کردن ایونت ها و سشن ها داریم به اسم event viewer که اونجا هم هست
باهاش query هم میشه زد:
logman query "Eventlog-System" -ets
اطلاعات مربوط به Eventlog-System رو میده(تمام پروایدر هایی که داخل سیستم لاگ میریزن رو نشون میده و از تمام پروایدر های ویندوز تبعیت میکنه لزوما همشون به صورت دیفالت لاگش وجود نداره) 
با لاگ من کارای دیگه هم میشه کرد:
اگر اتکر به یوزر ادمین دسترسی داشته باشه میتونه تو تریس سشن ایونت ها اختلال ایجاد کنه مثلا اگه چنل سکیوریتی اگر لاگ نده شاید به خاطر همین باشه که پروایدر stop یا delete شده باشه توسط هکر و کلا هکر وقتی به کرنل دسترسی داشته باشه میتونه کاری کنه که کلا لاگ تولید نشه

اگر لاگی که نشون بده لاگ stop شده نیاد (مثلا ایونت ویور استاپ بشه لاگ تولید میشه ولی اگر از کرنل لاگ دهی etw قطع بشه لاگ تولید نمیشه) باید با مانیتور کردن نقاطی که لاگ تولید نمیشه رو تحلیل کرد و باید incident response بدم به اون endpoint

پروایدرهای امنیتی که میخوان لاگ کاستوم خودشون داشته باشن هم از لاگمن استفاده میکنن مثل 
helk
این برای خودش یه دیتا مدل تعریف و بر اساس لاگ های خودش کار میکنه و خودشم یه ابزار داره به اسم SilkETW که این برای خودش ایونت تریس سشن میسازه و پروایدر مدنظرشو اینجا میبینه 
###### این edrها و ابزار های امنیتی برای این که لاگ کاستوم خودشون رو داشته باشند از لاگمن استفاده میکنند:
مثلا بخوام ببینم ایونت تریس سکیوتریتی از چه پروایدرهایی استفاده میکند میرم پاورشل رو ران ادمین میکنم یه متغیر میسازم و میگم لاگمن پروایدرهام رو بگیره
```bash
$etwproviders = logman query providers 
etwproviders | Where-Object {$_ -like "*security"}
```
==ابزار wep explorer برای این که ببینم یک پروایدر چه لاگ ها و event id هایی رو تولید میکنه ابزار تو خود ویندوز برای این کار و برای کار کردن و تغییرات(خود هکر هاهم استفاده میکنند برای این که هکر ها defense کارهارو دنبال نخود سیاه بفرستن): wevtutuil== تو cmd میزنم:
``` bash
wevtutil.exe get-publisher اسم پروایدر  /getevents:true /getmessage:true
```
هر نوع ایونت ایدی تو چنل سکیوریتی که قابل تولیده رو خروجیش رو میفرسته بر اساس ایونت ایدی و نمونه لاگش رو میده(wepexplorer بهترو تمیزتره)
پس کانسیومر ایونت لاگ سکیوریتی ماییم با استفاده از ابزار event viewer
پس هر چنلی که لاگ تولید میکنه از نقطه ی event trace session ها منیج میشه که ویندوز این event trace session اینارو بسته به نیاز برای ما و بسته به پروایدرها در نظر بگیره که ما بتونیم رد لاگ های تولیدی از کرنل رو بگیریم
دیدن کل پروایدرها:
```bash
$etwproviders
```
اون security auditing مربوط به چنل سکیوریتی میشه

#### ابزار دیگه برای لیست ایونت سشن تریس ها:
computer management
توی performance که بری :
event trace sessions
هست
رو هرکدوم بزنم اطلاعاتش میاد

### نحوه کار etw security provider:
فهمیدیم که یک event trace sessions هست که خروجیش رو میریزه اینجا و ما به عنوان مصرف کننده باید بریم سراغ event viewer البته event viewer صرفا reader هست و کار خاصی نمیکنه 
فایل evtx که داخل event viewer ریخته میشه داخل event viewer توسط event trace session ها جاییه که ما بهش رجوع میکنیم و لاگ هارو مصرف میکنیم

مسیر فایل evtx:(جایی که پروایدرها لاگ هاشون رو به فرمت evtx تولید میکنند)
C:\Windows\System32\winevt\Logs
برای incident response اگه زمان خیلی کم باشه سریع فایل سکیوریتی رو کپی میکنم میرم تو event viewer خودم باز میکنم مثلا چنل هایی که سریع باید بردارم پاورشل و سیسمان و سیستم و سکیوریتی و ایناست
تو ویندوز مدرن ایونت ویور میاد فرمت لاگ هایی که به شکل evtx هستند رو میخونه فرمت فایل ها به شکل xml دیزاین شدن که تو لایه های اپلیکیشن و سکیوریتی و غیره میتونم تو ایونت ویور لاگش رو تولید کنم تا بتونم بخونم
دیدن ساختار xml: تو ایونت ویور میرم رو بخش detail لاگ 
لاگ هایی که ایونت ویور تولید میکنه دو بخش داره: system  و event data
دیتا مدل کردن لاگ ها میاد لودی که روی سامانه میزاریم رو کم میکنه
لاگی که داخل سامانه siem هست معمولا event data رو نشون میده توی متادیتای لاگ
#### event id:
 ولی فیلد های دیگه هم داخل event viewer داریم که توسط سیستم درحال پر شدنه که بین اونا فیلد event id خیلی مهمه
 لاگ های ویندوزی در هر چنل مختص خودش با event id یونیک نمایش داده میشه یعنی تو چنل سکیوریتی با event id نمیبینم که the system time change برا اون باشه ولی مثلا تو یه چنل دیگه میتونه این event id وجود داشته باشه مثلا لاگ 1102 مبنی بر پاک شدن لاگ ویندوزی تولید میشه ولی 1102 درحالت کلی میتونه جاهای دیگه هم باشه تو چنلای دیگه برای همین باید موقع فیلتر کردن چنل رو همراه با event id فیتر کنم نه اینکه کل event id رو بزنم فیلتر بشه
 
 لاگ های ویندوزی به طور default دیتا های مناسبی برای ما ندارن و در حالت پایه فقط 10 تا 20 درصد سیگما رول ها قابل شناساییه و خیلی کمه
 خود چنل سکیوریتی(security auditing) تمام پروایدر های مهم رو داره ولی چون audit شون به طور پیش فرض فعال نیست لاگ تولید نمیکنند بعضی هاشون
 پس باید بریم سراغ audit لاگ ها (log enrichment) و اینجوری سطح شناسایی مون رو بالا میبریم
## کاربرد دیتا مدل ها:
### مپ کردن لاگ ها:
به جز لاگ ویندوزی لاگ وف و سرویس و فایروال و پروسس (پروسس ویندوز و لینوکس) و لاگ سوییچ ها و لاگ آنتی ویروس و edr و کلادفلر غیره داریم
هر کدوم به source ip یه چیزی میگن: 
فایروال= src
waf= source
service= src_ip
windows= source_ip
linux= چیز خاصی نمیگه
حالا مثلااز آیپی 1.1.1.1 تهدید دیدم میخوام برم رو siem م کوری بزنم تا ببینم پیرامون اون ip چه خبره اگه بخوام تو همه دیتا سورس هام اون ip رو بگردم نزدیک هفت هشت تا کوری بزنم ولی با دیتا مدل میام هر کدوم از حالت هارو مپ میکنم و میام به همه این حالت ها
waf= source
service= src_ip
windows= source_ip
linux= چیز خاصی نمیگه 
به جای اسماشون میگم src_ip به همشون و یدونه کوری میزنم برای همه هشت تا حالت 
پس کار دیتا مدل یکپارچه کردن فیلد ها و این عملیات رو خود siem انجام میشه
دیتا مدل کتگوری داره 
هر کدوم از siem ها دیتا مدل خاص خودشون رو استفاده میکنند:
splunk=cim
مثلا cim هر لاگی که بهش بدی میبره تو کتگوری خودش و براساس اون کار میکنه
### authentication:
دوباره هر کدوم از وف و ویندوز و لینوکس و غیره هر کدوم یه authentication دارن و میاد با کتگوری فرارش میده و خودش میدونه هر کدوم authentication ش چیه و مثلا وقتی میخواد دنبال authentication یوزر علی بگرده اگه از دیتا مدل استفاده کنه میاد تو دیتا مدل علی رو کوری میکنه و زمانی که تو هر دیتا سورسی که علی وجود داشت خروجی میاره
#### کتگوری های دیتامدل ها:
دیتا مدل ها به دیتا مدل های ریز تر تقسیم میشه و کتگوری های مختلف داره: نتورک و بدافزار و پروسس و غیره 
##### ترجمه کردن سیگما تو elastic:
مثلا تو رول سیگما میگه برو تو کتگوری process access رو لاگ هاش کار بکن حالا وقتی تو uncoder مپش میکنی رو elastic میگه جایی که تو ویندوز دیتات فیلد ایونت دیتا تارگت ایمیج وجود داشته باشه 
که این زیر مجموعه پروسس میشه یعنی باید برم تو کتگوری پروسس و اون فیلد رو بدست بیارم
پس ممکنه لاگ هایی که از ایونت ویور میگیرم رو دیگه با اون فیلد تو لاگ منیجمنت نبینم و با دیتا مدل خاص دیتا منیجمنتم ببینم
## لاگ های مهم ویندوز:
معمولا تشخیص لاگ های مهم بر اساس لاگ های مهمه
بیشترین میزارن تشخیص بر اساس ترک کردن یک پروسس انجام میشه یعنی باید دنبال لاگی بگردیم که بگه فلان پروسس با چه کامندی execte شده و کی اینکارو کرده که اون event id 4688 عه
### event id 4688:
تو ایونت ویور چنل سکیوریتی میزنم رو filter current log و event id رو میزنم
به من میگه که پروسس نیم svchost که parent ش سرویس بوده توسط creator process name که service.exe هست اجرا شده
یه لاگی هم نیازه که execute شدن پروسس هارو نشون بده---->process hacker شمای کلی ویندو
هر پروسسی که توسط یک end user ران میشه زیر مجموعه explorer.exe قرار میگیره و ران میشه
مثلا اگه پروسس cmd رو اتکر ران کنه پرنتش اکسپلورره و همیشه باید حواسمون باشه که explorer.exe پرنت(parent) چه پروسس هایی قرار میگیره که بفهمیم نرمال و غیرنرمال چیه که با خوندن لاگ 4688 میشه که بهمون میگه process explorer چیو ران کرده ولی باز اطلاعات کاملی نمیده باید audit ش رو فعال کنیم تا فیلد های کامند لاین و پروسس کامند لاین پر بشه ولی باز parent process command line و هش فایل رو نمیده بهمون و فقط کامند لاینشو میده 
وقتی داخل لاگم هش رو بندازه تو threat intelligence به کار میاد  تا هش پروسس های مخرب و بدافزار داشته باشیم تا با فایل های خودمون مقایسه کنیم که باید با سیسمان انجام بشه
به جز رول های تو process create تو چنل سکیوریتی لاگ داریم
و لاگ های پاورشل هم باید فعال کنیم
سیسمان باید نصب کنیم 
تحلیل اینا 1 2 سال طول میکشه یادگیریش
بعدش رو اپلیکیشن سرویس و اپ لاکر و تمام پروایدر های مهم ویندوز باید بریم
تمام لاگ های اینا کلا داخل ایونت ویور کمک میکنه بهم
ویندوز رو دیفالت 9 درصد میتونه تشخصی بده حملات رو (که اونم همش حلقه های ابهامه)

سیگما بر اساس کتگوری های detection لاگ: ویندوز اینقدر میتونه در حالت دیفالت یا غیر دیفالت رول های سیگما رو میتونه ساپورت کنه
اونایی که منتهی به audit میشه رو باید ما تشخیص بدیم و فعالش کنیم
پارشیال= یه بخشی
براساس event id:
پس در حالت کلی خیلی از event id ها فعال نیست (یا ما فعالش کنیم یا کلا فعال نیست)
### مثلا سناریوی کامل حمله برای اکانت منیجمنت توسط هکر (براساس صفحه4):
- اول اتکر وارد سازمان میشه دسترسی یه کاربر میگیره(ممکنه سر وصدا ایجاد کنه) یا یه یوزر جدید میسازه(بهتره) 
- بعد اون یوزری که ساخته رو باید enable کنه 
- بعد برای حفظ دسترسی های مختلف به الگوهای مختلف میاد یوزر رو اد میکنه تو گروه سکیوریتی(event 4756)، ممکنه بخواد local privilage scalation انجام بده برای دسترسی بالاتر 
- بعد یه مدت که کارشو انجام داد یوزرشو disable یا کلا دیلیت یوزر(بسته به سیاست اتکر)
- مثلا اد کردن یوزر جدید تو cmd(ران ادمین):
- net user username password /ADD
#### ولی ممکنه لاگش نیفته به خاطر audit policy:
ویندوز یه سری قابلیت به ما میده که یه سری قابلیت هارو فعال کنیم برای مانیتور کردن بهتر و دیدن جزییات بیشتر(enrichment)
برای این کار: edit group policy
ما domain group policy هم داریم که ادمین ها از دامین بیان فعالش کنن یا اینکه per user تعریف کنیم در نهایت هرکدوم تو group policy editor ش قابل مشاهده ست:
local computer policy > windows settings > security settings > local settings > audit policies & advanced audit policies
##### فرق audit policies & advanced audit policies:
حجم لاگ معلولی خیلی بیشتر از ادونسشه
اگه یه پالیسی رو در معمولی فعال کنیم همه شون فعال میشه و یه حجم زیادیش بدرد نمیخوره پس برای مدیریت بهتر روی لاگ کاستوم مورد نظر از ادونس استفاده میکنم
اگه از audit ادونس استفاده میکنم و یکیشو فعال کنم دیگه ویندوز به قبلیا نگاه نمیکنه و از ادیت های سنتی نگاه نمیکنه و فقط از ادونس پیروی میکنه
پس برای مدیریت صحیح باید برم سراغ ادونس کلا زمانی بهتره فعال کنم که نیاز کنم
###### ابزار auditpol برای کار با ادیت پالیسی ها:
تو پاورشل ران ادمین میزنم:
 .\auditpol.exe /get /category:*
 برای دیدن تمام کتگوری هام
 منابع خوب در این زمینه:
 پروژه yamato:

https://github.com/Yamato-Security/EnableWindowsLogSettings/blob/main/ConfiguringSecurityLogAuditPolicies.md
hayabusa 
این دوتا هم مهمه:
https://www.ultimatewindowssecurity.com/securitylog

این میگه کدوم ایونت ایدی ها باید مانیتور بشن و چرا؟:

https://www.socinvestigation.com/threat-hunting-using-windows-security-log/
what2log:
(خوبه برای اینکه پالیسی مدنظرمون رو انتخاب میکنیم و اسکریپت میده برای فعال یا غیر فعال سازی ادیت های مدنظر)
یه ادیت پول هم زیرش میزاره تو سایت که میام سیو میکنم تو یه فایل و بچ فایل میسازم ازش که اون آدیت هام فعال میشه
بهترین کار اینه که این چند تارو باهم استفاده کنم
کلا در نهایت باید یه بچ فایل درست حسابی داشته باشیم که قبل کار run as admin ش کنم و استفاده کنم
yamato:
تمام ادونس ادیت پالیسی هارو گذاشته و مهم تر اینکه بر اساس ایونت ایدی ها میگه اگر فلان ادیت رو فعال کنم چه ایونت ایدی میده
بر اساس این ایونت ایدی میگه چندتا سیگما رول هم پوشش میدی
اینجوری میشه پیش بینی کرد وقتی اتکر وارد سازمان میشه حرکت های جانبیش چیه بعدش
میرم سراغ window log analysis هام مثلا میگم فلان ایونت ایدی نیازه میام سرچش میکنم (ctrl+F) میبینم زیرمجموعه چه ادیتیه اونو فعال میکنم

حالا میخوام بسته به سناریو لاگ تولید کنم (اگه دامین داشته باشم تیکه تیکه گروه بندی میکنم تو دامین و نتیجشو تو لاگ منیجمنتم ببینم یعنی مثلا یکی نویز زیاد داره نمیخوامش)
از guidش استفاده کرده
البته اون ادیت پول هایی که اون گذاشته رو اگه همشو تو فایل بنویسی و ران ادمین کنی نویز زیادی ایجاد میکنه
دیدن کل ادیت هام:
 .\auditpol.exe /get /category:*
 زمانی که با ادیت پول میام پالیسی هامو اجرا میکنم تو گروپ پالیسی ادیتورم نمیفته و باز همون not configured میزنه(مشکل تو ویندوز هست کلا) و مرجع ما باید auditpool باشه (تو پاورشل همون
  .\auditpol.exe /get /category:*
 این pdf میاد بسته به سناریو event هارو میگه(برای شناسایی هر موضوع میگه کدوم ایونت ها نیازه)
### event id 4625:
 توی ایونت های authentication(لاگ این و غیره)، subject تولید کننده لاگه
 میگه روی ادمینیستریتور لاگین فیل انجام شده
 دلیل فیل شدن و status و substatus رو هم میگه و با status میرم سرچ میکنم تو منابعم
 میام این جدول رو تو siem خودم مپ میکنم که هر بار نیاز نباشه چک کنم
 اگه زیاد substatus غلط بود میفهمم که اتکر لیست کامل یوزر هارو داره ولی پسورد هارو داره امتحان میکنه(بروت فورس)
 اکانت لاک اوت پالیسی سازمان(account lockout policy) باید طوری باشه که مثلا اگر برای یک اکانت، 3 بار پشت هم پسورد اشتباه زد یا تو نیم ساعت 5 بار اشتباه زد، اکانتش لاک بشه تا از پسورد اسپری جلوگیری بشه
#### password spray:
در حالت سنتی بروت فورس، اتکر میومد یه کاربر و تارگت میکرد و یه دایرکتوری پسورد رو روی علی تست میکرد و یهو میدیدم 100 تا ایونت 4625 دارم(با همون دلیل یوزر درسته ولی پسورد اشتباهه) و راحت قابل تشخیص بوده قبلا تو siem ها و غیره 
ولی امروزه به خاطر lockout policy مثلا دیگه بعد 3 بار اشتباه زدن لاک میشه برای همین از پسورد اسپری استفاده میکنن:
مثلا یه سازمان پسورد دیفالتش از 123x یا x123 پیروی میکنه(مثلا پسورد ماکروسافتی P@ssw0rd) مثلا میاد یه پسوردی که احتمالا جواب بده رو رو سه تا اکانت مختلف میزنه بعد اگه نشد پسورد دوم احتمالی رو رو اون سه تا تست میکنه و مثلا اگه جواب نداد برای بار سوم بالاخره یه پسورد جواب میده برای یکیش

(ممکنه 500 تا اکانت و تست کنه و اگه lockout policy رو ندونه ممکنه 10 تا لاک بخوره)
موقع مانیتور اگه ببینم یدونه ip رو 50 تا یوزر بیاد ایونت ایدی 4625 بندازه صددرصد پسورد اسپری هست برای همین اگه بیام 4625 رو با substatus لاک ات چک کنم رو اون لاک اوت میتونم اثر هارو بگیرم از اتکر و وقتی میخوام ببینم که موفق شده اتکر یا نه باید event id 4624 که نشون دهنده موفق شدنه رو کدوم destination میتونم ببینم

مثلا یوزکیس 72 تو ایونت ایدی 4625:
مثلا اتکر میاد لیست یوزر هارو میکشه بیرون و شروع به تست authentication  میکنه و بروت فورس میکنه، و این اکانت دیسیبل خیلی مهمه چون یهو میاد رو این تست بکنه وقی اکانت فعال نیست و چون غیر عادیه قابل تشخیص میشه
### event id 4624:
زیر مجموعه security auditing
زیاد نویز میندازه 
باید سناریو محور تعریف و تحلیل بشه چون مستقیم نمیشه تعریف کرد
اون new logon مهمه که اونجا میگه چه کسی روی هاست authenticate کرده
https://www.manageengine.com/products/active-directory-audit/kb/windows-security-log-event-id-4624.html
### event id 4697:
مربوط به service install 
تو چنل سیستم هم 7045 داریم چون میان سرویس خودشون رو به این وسیله persistence میکنن
### این چارت هم خیلی مهمه(برای (
https://www.socinvestigation.com/threat-hunting-using-windows-security-log/)[security investigation]):
![Hunting_Security_Log (1)](https://github.com/user-attachments/assets/ab0c6d98-8fb3-44ec-82a9-245e1f77ca7c)
